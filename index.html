<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala de Trabalho</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      margin: 0;
      box-sizing: border-box;
    }

    .hidden {
      display: none;
    }

    table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%;
      overflow-x: auto;
    }

    td, th {
      border: 1px solid #ccc;
      padding: 5px;
      width: 40px;
      height: 40px;
      text-align: center;
    }

    .folga {
      background-color: #8bc34a;
      color: white;
      font-weight: bold;
    }

    input, button, select {
      margin: 5px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }

    .mesTitulo {
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
    }

    /* Estilo para abas */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ccc;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f1f1f1;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }

    .tab.active {
      background-color: #8bc34a;
      color: white;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Estilo para tabela de ranking */
    .ranking-table {
      width: 100%;
      margin-top: 20px;
    }

    .ranking-table th {
      background-color: #f1f1f1;
    }

    .ranking-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .ranking-table tr:hover {
      background-color: #e9e9e9;
    }

    .ranking-header {
      margin-top: 20px;
      font-weight: bold;
      font-size: 16px;
    }

    /* Estilo para filtros de ranking */
    .filtros-ranking {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }

    .filtro-item {
      flex: 1;
      min-width: 200px;
    }

    .filtro-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    /* Estilo para posição do usuário no ranking */
    .posicao-usuario {
      margin-top: 20px;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 5px;
      border-left: 4px solid #8bc34a;
    }

    .posicao-usuario h4 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    .posicao-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .posicao-info strong {
      font-weight: bold;
    }

    /* Estilo para calendário de folgas */
    .calendario-mes {
      margin-bottom: 30px;
    }
    
    .calendario-mes h3 {
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #8bc34a;
      padding-bottom: 5px;
    }
    
    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .dia-header {
      font-weight: bold;
      text-align: center;
      padding: 5px;
      background-color: #f1f1f1;
    }
    
    .dia-celula {
      min-height: 80px;
      border: 1px solid #ddd;
      padding: 5px;
      position: relative;
    }
    
    .dia-numero {
      position: absolute;
      top: 5px;
      right: 5px;
      font-weight: bold;
      color: #555;
    }
    
    .dia-folgas {
      margin-top: 25px;
      font-size: 12px;
    }
    
    .dia-folgas span {
      display: block;
      background-color: #8bc34a;
      color: white;
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    .dia-vazio {
      background-color: #f9f9f9;
    }
    
    .hoje {
      border: 2px solid #ff5722;
    }

    /* Estilos para dados detalhados */
    .dados-detalhados-item {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .dados-detalhados-item h5 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }

    .dados-detalhados-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .dados-detalhados-valores {
      font-size: 14px;
      color: #666;
    }

    .dados-detalhados-acoes {
      display: flex;
      gap: 10px;
    }

    .btn-editar, .btn-excluir {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-editar {
      background-color: #2196F3;
      color: white;
    }

    .btn-editar:hover {
      background-color: #1976D2;
    }

    .btn-excluir {
      background-color: #f44336;
      color: white;
    }

    .btn-excluir:hover {
      background-color: #d32f2f;
    }

    /* Modal para edição */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 5px;
      width: 80%;
      max-width: 500px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      margin: 0;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-form label {
      font-weight: bold;
    }

    .modal-form input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-salvar, .btn-cancelar {
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .btn-salvar {
      background-color: #4CAF50;
      color: white;
    }

    .btn-salvar:hover {
      background-color: #45a049;
    }

    .btn-cancelar {
      background-color: #f44336;
      color: white;
    }

    .btn-cancelar:hover {
      background-color: #d32f2f;
    }

    @media (max-width: 600px) {
      table {
        font-size: 12px;
      }

      td, th {
        padding: 3px;
        width: 30px;
        height: 30px;
      }

      .mesTitulo {
        font-size: 16px;
      }

      button, input, select {
        font-size: 14px;
      }
      
      .filtros-ranking {
        flex-direction: column;
      }
      
      .calendario-grid {
        grid-template-columns: repeat(7, 1fr);
        font-size: 11px;
      }
      
      .dia-celula {
        min-height: 60px;
      }

      .dados-detalhados-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .dados-detalhados-acoes {
        margin-top: 10px;
      }

      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
    }
  
    .tema-escuro {
      background-color: #121212;
      color: #f5f5f5;
    }
    .tema-escuro input,
    .tema-escuro select,
    .tema-escuro button {
      background-color: #1e1e1e;
      color: #f5f5f5;
      border: 1px solid #444;
    }
    
    .tema-escuro .tab {
      background-color: #333;
      color: #f5f5f5;
    }
    
    .tema-escuro .tab.active {
      background-color: #6a9739;
    }
    
    .tema-escuro .ranking-table th {
      background-color: #333;
    }
    
    .tema-escuro .ranking-table tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    
    .tema-escuro .ranking-table tr:hover {
      background-color: #3a3a3a;
    }
    
    .tema-escuro .filtros-ranking {
      background-color: #2a2a2a;
    }
    
    .tema-escuro .posicao-usuario {
      background-color: #263238;
      border-left: 4px solid #6a9739;
    }
    
    .tema-escuro .dia-header {
      background-color: #333;
      color: #f5f5f5;
    }
    
    .tema-escuro .dia-celula {
      border-color: #444;
      background-color: #1e1e1e;
    }
    
    .tema-escuro .dia-vazio {
      background-color: #2a2a2a;
    }
    
    .tema-escuro .dia-numero {
      color: #ccc;
    }

    .tema-escuro .dados-detalhados-item {
      background-color: #2a2a2a;
      border-color: #444;
    }

    .tema-escuro .dados-detalhados-item h5 {
      color: #f5f5f5;
    }

    .tema-escuro .dados-detalhados-valores {
      color: #ccc;
    }

    .tema-escuro .modal-content {
      background-color: #2a2a2a;
      border-color: #444;
      color: #f5f5f5;
    }

    .tema-escuro .modal-form input {
      background-color: #1e1e1e;
      border-color: #444;
      color: #f5f5f5;
    }

    .progress-container {
      width: 100%;
      background-color: #f3f3f3;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar {
      height: 20px;
      background-color: #4CAF50;
      width: 0%;
      color: black;
      border-radius: 5px;
    }

    .tema-escuro .progress-container {
      background-color: #333;
    }

    .tema-escuro .progress-bar {
      background-color: #6a9739;
    }
  </style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="botaoSairTopo" style="position: absolute; top: 10px; right: 10px; display: none;">
  <button onclick="logout()">Sair</button>
</div>

<div id="adminBackupBtn" style="display: none; text-align: center; margin-top: 60px;">
  <button onclick="backupParaFirebase()">Backup manual (usuários + folgas + ranking + metas mensais) SALVAR</button>
</div>

<h2>Login</h2>
<div id="loginDiv">
  <input type="text" id="login" placeholder="Login">
  <input type="password" id="senha" placeholder="Senha">
  <label><input type="checkbox" id="mostrarSenha" onchange="toggleSenha()"> Mostrar senha</label>
  <br>
  <button onclick="fazerLogin()">Entrar</button>
</div>

<div id="app" class="hidden">
  <h2>Bem-vindo, <span id="usuarioNome"></span> (<span id="usuarioTipo"></span>)</h2>
  
  <span style="display: inline-block; margin-right: 10px;">
    <input type="password" id="novaSenhaUsuario" placeholder="Nova senha" style="max-width: 150px;">
    <button onclick="alterarSenha()">Alterar Senha</button>
  </span>

  <button onclick="alternarTema()">Alternar Tema</button>
  <span id="toggleBackupAutoSpan" style="display: none; margin-left: 10px;">
    <label style="font-weight: bold;">
      <input type="checkbox" id="toggleBackupAuto" onchange="alternarBackupAuto()">
      Backup automático ao alterar usuário/folga/ranking/meta
    </label>
  </span>

  <!-- Abas de navegação -->
  <div class="tabs" id="appTabs">
    <div class="tab active" data-tab="folgas">Escala de Folgas</div>
    <div class="tab" data-tab="calendario">Calendário de Folgas</div>
    <div class="tab" data-tab="ranking">Ranking de Vendas</div>
    <div class="tab" data-tab="metas">Metas de Vendas</div>
    <div class="tab" data-tab="metasGrid">Metas de Grid</div>
  </div>

  <!-- Conteúdo da aba de folgas -->
  <div class="tab-content active" id="folgasContent">
    <div id="adminPanel" class="hidden">
      <h3>Cadastrar novo funcionário</h3>
      <input type="text" id="novoLogin" placeholder="Login">
      <input type="password" id="novaSenha" placeholder="Senha">
      <select id="novoTipo">
        <option value="funcionario">Funcionário</option>
        <option value="admin">Administrador</option>
      </select>
      <select id="novoTurno">
        <option value="manha">Turno da Manhã</option>
        <option value="tarde">Turno da Tarde</option>
      </select>
      <button onclick="cadastrarUsuario()">Cadastrar</button>

      <h3>Gerenciar usuários</h3>
      <select id="listaUsuariosSelect"></select><br>
      <input type="text" id="editarLogin" placeholder="Novo login">
      <input type="password" id="editarSenha" placeholder="Nova senha">
      <select id="editarTipo">
        <option value="funcionario">Funcionário</option>
        <option value="admin">Administrador</option>
      </select>
      <select id="editarTurno">
        <option value="manha">Turno da Manhã</option>
        <option value="tarde">Turno da Tarde</option>
      </select>
      <button onclick="alterarUsuario()">Alterar</button>
      <button onclick="removerUsuario()">Remover</button>

      <h3>Atribuir folga a funcionário</h3>
      <select id="usuarioFolgaSelect"></select>
      <input type="text" id="folgaAdminData">
      <button onclick="atribuirFolga()">Atribuir Folga</button>

      <h3>Editar folga de funcionário</h3>
      <select id="usuarioEditarFolgaSelect" onchange="popularFolgasParaEdicao()"></select>
      <select id="dataFolgaEditarSelect"></select>
      <input type="date" id="novaDataFolgaInput">
      <button onclick="editarFolga()">Editar Folga</button>
      <button onclick="excluirFolga()">Excluir Folga</button>

      <h3>Visualizar todas as folgas</h3>
      <div id="listaFolgas"></div>
      <h3>Visualizar calendário de folgas de um funcionário</h3>
      <select id="visualizarFuncionarioSelect" onchange="desenharCalendariosFuncionario()"></select>
      <div id="calendarioFuncionario"></div>
    </div>

    <h3>Calendário Anual de Folgas</h3>
    <div id="calendarios"></div>
  </div>
  
  <!-- Conteúdo da nova aba de calendário de folgas -->
  <div class="tab-content" id="calendarioContent">
    <h3>Calendário Mensal de Folgas</h3>
    
    <div class="filtros-ranking">
      <div class="filtro-item">
        <label for="filtroMesCalendario">Selecione o mês:</label>
        <select id="filtroMesCalendario" onchange="atualizarCalendarioFolgas()">
          <option value="todos">Todos os meses</option>
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Março</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
      </div>
      
      <div class="filtro-item">
        <label for="filtroAnoCalendario">Selecione o ano:</label>
        <select id="filtroAnoCalendario" onchange="atualizarCalendarioFolgas()">
          <!-- Anos serão preenchidos dinamicamente -->
        </select>
      </div>
      
      <div class="filtro-item">
        <label for="filtroTurnoCalendario">Filtrar por turno:</label>
        <select id="filtroTurnoCalendario" onchange="atualizarCalendarioFolgas()">
          <option value="todos">Todos os turnos</option>
          <option value="manha">Turno da Manhã</option>
          <option value="tarde">Turno da Tarde</option>
        </select>
      </div>
    </div>
    
    <div id="calendarioFolgas"></div>
  </div>

  <!-- Conteúdo da aba de ranking -->
  <div class="tab-content" id="rankingContent">
    <h3>Ranking de Vendas e Abastecimentos</h3>
    
    <!-- Formulário para adicionar dados de vendas e abastecimentos -->
    <div id="rankingForm" class="hidden">
      <h4>Adicionar Dados Diários</h4>
      <select id="usuarioRankingSelect"></select>
      <input type="date" id="dataRanking" value="">
      <input type="number" id="totalVendas" placeholder="Total de Vendas" min="0">
      <input type="number" id="totalAbastecimentos" placeholder="Total de Abastecimentos" min="0">
      <input type="number" id="totalGrid" placeholder="Total de Grid" min="0">
      <button onclick="adicionarDadosRanking()">Salvar Dados</button>
    </div>
    
    <!-- Filtros de ranking -->
    <div class="filtros-ranking">
      <div class="filtro-item">
        <label for="filtroTurnoSelect">Filtrar por Turno:</label>
        <select id="filtroTurnoSelect" onchange="atualizarTabelasRanking()">
          <option value="todos">Todos os Turnos</option>
          <option value="manha">Turno da Manhã</option>
          <option value="tarde">Turno da Tarde</option>
        </select>
      </div>
      
      <div class="filtro-item">
        <label for="filtroMesSelect">Filtrar por Mês:</label>
        <select id="filtroMesSelect" onchange="atualizarTabelasRanking()">
          <!-- Opções de mês serão adicionadas dinamicamente -->
        </select>
      </div>

      <div class="filtro-item">
        <label for="ordenacaoRankingSelect">Ordenar Ranking por:</label>
        <select id="ordenacaoRankingSelect" onchange="atualizarTabelasRanking()">
          <option value="vendas">Maior Total de Vendas</option>
          <option value="abastecimentos">Maior Total de Abastecimentos</option>
          <option value="grid">Maior Total de Grid</option>
        </select>
      </div>
    </div>
    
    <!-- Exibição da posição do usuário no ranking (para funcionários) -->
    <div id="posicaoUsuario" class="posicao-usuario" style="display: none;">
      <h4>Sua Posição no Ranking</h4>
      <div class="posicao-info">
        <span>Posição no Ranking de Vendas:</span>
        <strong id="posicaoVendas">-</strong>
      </div>
      <div class="posicao-info">
        <span>Total de Vendas:</span>
        <strong id="totalVendasUsuario">0</strong>
      </div>
      <div class="posicao-info">
        <span>Posição no Ranking de Abastecimentos:</span>
        <strong id="posicaoAbastecimentos">-</strong>
      </div>
      <div class="posicao-info">
        <span>Total de Abastecimentos:</span>
        <strong id="totalAbastecimentosUsuario">0</strong>
      </div>
      <div class="posicao-info">
        <span>Total de Grid:</span>
        <strong id="totalGridUsuario">0</strong>
      </div>
    </div>
    
    <!-- Tabelas de ranking (visíveis apenas para admin) -->
    <div id="tabelasRanking">
      <div class="ranking-header">Ranking do Turno da Manhã</div>
      <table class="ranking-table" id="rankingManha">
        <thead>
          <tr>
            <th>Funcionário</th>
            <th>Total de Vendas</th>
            <th>Total de Abastecimentos</th>
            <th>Total de Grid</th>
          </tr>
        </thead>
        <tbody id="rankingManhaTbody">
          <!-- Dados serão inseridos dinamicamente -->
        </tbody>
      </table>
      
      <div class="ranking-header">Ranking do Turno da Tarde</div>
      <table class="ranking-table" id="rankingTarde">
        <thead>
          <tr>
            <th>Funcionário</th>
            <th>Total de Vendas</th>
            <th>Total de Abastecimentos</th>
            <th>Total de Grid</th>
          </tr>
        </thead>
        <tbody id="rankingTardeTbody">
          <!-- Dados serão inseridos dinamicamente -->
        </tbody>
      </table>
    </div>

    <!-- Seção de Dados Detalhados por Dia -->
    <div id="dadosDetalhadosDiarios" style="margin-top: 30px;">
      <h4 class="ranking-header">Dados Detalhados por Dia</h4>
      <div id="listaDadosDetalhados">
        <!-- Os dados detalhados por usuário e dia serão inseridos aqui via JavaScript -->
        <p>Carregando dados detalhados...</p>
      </div>
    </div>
  </div>

  <!-- Conteúdo da aba de metas -->
  <div class="tab-content" id="metasContent">
    <div id="metaGeralAdminSection" class="hidden" style="margin-bottom: 20px; padding: 15px; background-color: #e8f5e9; border-radius: 5px; border-left: 4px solid #8bc34a;">
      <h4>Definir Meta de Vendas Mensal</h4>
      <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
        <div style="flex: 1; min-width: 150px;">
          <label for="metaGeralMesSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Selecione o Mês:</label>
          <select id="metaGeralMesSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label for="metaGeralInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Meta de Vendas:</label>
          <input type="number" id="metaGeralInput" placeholder="Ex: 1000" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <button onclick="salvarMetaGeral()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">Salvar Meta para o Mês</button>
      </div>
    </div>
    
    <!-- Filtros de metas -->
    <div class="filtros-ranking">
      <div class="filtro-item">
        <label for="filtroTurnoMetas">Filtrar por Turno:</label>
        <select id="filtroTurnoMetas" onchange="atualizarTabelasMetas()">
          <option value="todos">Todos os Turnos</option>
          <option value="manha">Turno da Manhã</option>
          <option value="tarde">Turno da Tarde</option>
        </select>
      </div>
      
      <div class="filtro-item">
        <label for="filtroMesMetas">Filtrar por Mês:</label>
        <select id="filtroMesMetas" onchange="atualizarTabelasMetas()">
          <!-- Opções de mês serão adicionadas dinamicamente -->
        </select>
      </div>
    </div>
    <h3>Metas de Vendas - Turno da Manhã</h3>
    <table class="metas-table" id="metasManhaTable">
      <thead>
        <tr>
          <th>Funcionário</th>
          <th>Vendas/Falta</th>
          <th>Progresso</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão preenchidos via JavaScript -->
      </tbody>
    </table>

    <h3>Metas de Vendas - Turno da Tarde</h3>
    <table class="metas-table" id="metasTardeTable">
      <thead>
        <tr>
          <th>Funcionário</th>
          <th>Vendas/Falta</th>
          <th>Progresso</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão preenchidos via JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Conteúdo da aba de metas de grid -->
  <div class="tab-content" id="metasGridContent">
    <div id="metaGeralGridAdminSection" class="hidden" style="margin-bottom: 20px; padding: 15px; background-color: #e8f5e9; border-radius: 5px; border-left: 4px solid #8bc34a;">
      <h4>Definir Meta de Grid Mensal</h4>
      <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
        <div style="flex: 1; min-width: 150px;">
          <label for="metaGeralGridMesSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Selecione o Mês:</label>
          <select id="metaGeralGridMesSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
            <option value="0">Janeiro</option>
            <option value="1">Fevereiro</option>
            <option value="2">Março</option>
            <option value="3">Abril</option>
            <option value="4">Maio</option>
            <option value="5">Junho</option>
            <option value="6">Julho</option>
            <option value="7">Agosto</option>
            <option value="8">Setembro</option>
            <option value="9">Outubro</option>
            <option value="10">Novembro</option>
            <option value="11">Dezembro</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label for="metaGeralGridInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Meta de Grid:</label>
          <input type="number" id="metaGeralGridInput" placeholder="Ex: 500" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <button onclick="salvarMetaGeralGrid()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">Salvar Meta para o Mês</button>
      </div>
    </div>
    
    <!-- Filtros de metas de grid -->
    <div class="filtros-ranking">
      <div class="filtro-item">
        <label for="filtroTurnoMetasGrid">Filtrar por Turno:</label>
        <select id="filtroTurnoMetasGrid" onchange="atualizarTabelasMetasGrid()">
          <option value="todos">Todos os Turnos</option>
          <option value="manha">Turno da Manhã</option>
          <option value="tarde">Turno da Tarde</option>
        </select>
      </div>
      
      <div class="filtro-item">
        <label for="filtroMesMetasGrid">Filtrar por Mês:</label>
        <select id="filtroMesMetasGrid" onchange="atualizarTabelasMetasGrid()">
          <!-- Opções de mês serão adicionadas dinamicamente -->
        </select>
      </div>
    </div>
    <h3>Metas de Grid - Turno da Manhã</h3>
    <table class="metas-table" id="metasGridManhaTable">
      <thead>
        <tr>
          <th>Funcionário</th>
          <th>Grid/Falta</th>
          <th>Progresso</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão preenchidos via JavaScript -->
      </tbody>
    </table>

    <h3>Metas de Grid - Turno da Tarde</h3>
    <table class="metas-table" id="metasGridTardeTable">
      <thead>
        <tr>
          <th>Funcionário</th>
          <th>Grid/Falta</th>
          <th>Progresso</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão preenchidos via JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para edição de dados -->
<div id="modalEdicao" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Editar Dados do Dia</h3>
      <span class="close" onclick="fecharModalEdicao()">&times;</span>
    </div>
    <div class="modal-form">
      <label for="modalUsuario">Usuário:</label>
      <input type="text" id="modalUsuario" readonly>
      
      <label for="modalData">Data:</label>
      <input type="date" id="modalData" readonly>
      
      <label for="modalVendas">Total de Vendas:</label>
      <input type="number" id="modalVendas" min="0">
      
      <label for="modalAbastecimentos">Total de Abastecimentos:</label>
      <input type="number" id="modalAbastecimentos" min="0">
      
      <label for="modalGrid">Total de Grid:</label>
      <input type="number" id="modalGrid" min="0">
    </div>
    <div class="modal-actions">
      <button class="btn-salvar" onclick="salvarEdicaoDados()">Salvar</button>
      <button class="btn-cancelar" onclick="fecharModalEdicao()">Cancelar</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyAUdduUj1JIkorI_DD2cT44rOjLXTnD-oE",
  authDomain: "escala-17237.firebaseapp.com",
  databaseURL: "https://escala-17237-default-rtdb.firebaseio.com",
  projectId: "escala-17237",
  storageBucket: "escala-17237.firebasestorage.app",
  messagingSenderId: "512909333959",
  appId: "1:512909333959:web:0ef8e3b238f3746aa235e2"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Garante que o usuário admin esteja sempre presente e atualiza a senha se necessário
  let usuariosExistentes = JSON.parse(localStorage.getItem("usuarios")) || [];
  const adminUser = { login: "admin", senha: "admin123", tipo: "admin", turno: "manha" };
  
  const adminIndex = usuariosExistentes.findIndex(u => u.login === "admin");
  if (adminIndex === -1) {
    usuariosExistentes.unshift(adminUser); // Adiciona no início se não existir
  } else {
    usuariosExistentes[adminIndex] = adminUser; // Atualiza o usuário admin existente
  }

  // Adiciona outros usuários se o localStorage estiver vazio ou se não existirem
  const outrosUsuarios = [
    { login: "joao", senha: "1234", tipo: "funcionario", turno: "manha" },
    { login: "maria", senha: "abcd", tipo: "funcionario", turno: "tarde" }
  ];
  outrosUsuarios.forEach(novoUser => {
    if (!usuariosExistentes.some(u => u.login === novoUser.login)) {
      usuariosExistentes.push(novoUser);
    }
  });
  localStorage.setItem("usuarios", JSON.stringify(usuariosExistentes));

  // Inicialização de dados de ranking no localStorage
  if (!localStorage.getItem("ranking")) {
    localStorage.setItem("ranking", JSON.stringify({}));
  }

  let usuarioLogado = null;

  // Função para alternar entre abas
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove a classe active de todas as abas
        tabs.forEach(t => t.classList.remove('active'));
        // Adiciona a classe active na aba clicada
        this.classList.add('active');
        
        // Esconde todos os conteúdos de aba
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Mostra o conteúdo da aba selecionada
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId + 'Content').classList.add('active');
        
        // Se a aba for de calendário, atualiza o calendário de folgas
        if (tabId === 'calendario') {
          atualizarCalendarioFolgas();
        }
        
        // Se a aba for de metas, atualiza as tabelas de metas
        if (tabId === 'metas') {
          preencherFiltroMesMetas();
          atualizarTabelasMetas();
        }
        if (tabId === 'metasGrid') {
          preencherFiltroMesMetasGrid();
          atualizarTabelasMetasGrid();
        }
      });
    });
    
    // Preencher o select de anos para o calendário
    const anoAtual = new Date().getFullYear();
    const selectAno = document.getElementById('filtroAnoCalendario');
    for (let i = anoAtual - 2; i <= anoAtual + 2; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      if (i === anoAtual) {
        option.selected = true;
      }
      selectAno.appendChild(option);
    }
    
    // Definir o mês atual como selecionado
    const mesAtual = new Date().getMonth();
    document.getElementById('filtroMesCalendario').value = mesAtual;
  });

  function toggleSenha() {
    const senhaInput = document.getElementById('senha');
    senhaInput.type = document.getElementById('mostrarSenha').checked ? 'text' : 'password';
  }

  // Função para ler usuários do Firebase
  async function lerUsuariosDoFirebase() {
    try {
      const snapshot = await db.collection("usuarios").get();
      const usuarios = [];
      snapshot.forEach(doc => {
        usuarios.push(doc.data());
      });
      return usuarios;
    } catch (error) {
      console.error("Erro ao ler usuários do Firebase:", error);
      return null;
    }
  }

  async function fazerLogin() {
    const login = document.getElementById("login").value;
    const senha = document.getElementById("senha").value;

    if (!login || !senha) {
      alert('Preencha todos os campos!');
      return;
    }

    // Tentar carregar usuários do Firebase primeiro
    let usuarios = await lerUsuariosDoFirebase();
    
    // Se falhar, usar localStorage como fallback
    if (!usuarios || usuarios.length === 0) {
      console.log("Carregando usuários do localStorage como fallback");
      usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
      
      // Fallback: Garante que o usuário admin esteja sempre presente para login
      const adminUser = { login: "admin", senha: "admin123", tipo: "admin", turno: "manha" };
      const adminExists = usuarios.some(u => u.login === "admin");
      if (!adminExists) {
        usuarios.unshift(adminUser);
        localStorage.setItem("usuarios", JSON.stringify(usuarios));
      } else {
        // Atualiza a senha do admin se ela foi alterada no código e não no localStorage
        const currentAdmin = usuarios.find(u => u.login === "admin");
        if (currentAdmin && currentAdmin.senha !== adminUser.senha) {
          usuarios = usuarios.map(u => u.login === "admin" ? adminUser : u);
          localStorage.setItem("usuarios", JSON.stringify(usuarios));
        }
      }
    } else {
      console.log("Usuários carregados do Firebase");
      // Sincronizar com localStorage
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
    }

    console.log("Tentativa de login para:", login);
    console.log("Usuários carregados:", usuarios);

    const user = usuarios.find(u => u.login.toLowerCase() === login.toLowerCase() && u.senha === senha);
    if (user) {
      usuarioLogado = user;
      document.getElementById('usuarioNome').textContent = user.login;
      document.getElementById('usuarioTipo').textContent = user.tipo;
      document.getElementById('loginDiv').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('botaoSairTopo').style.display = 'block';

      if (user.tipo === 'admin') {
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminBackupBtn').style.display = 'block';
        document.getElementById('toggleBackupAutoSpan').style.display = 'inline-block';
        document.getElementById('tabelasRanking').style.display = 'block';
        document.getElementById('posicaoUsuario').style.display = 'none';
        // Mostrar seção de meta geral para administradores
        const metaGeralSection = document.getElementById('metaGeralAdminSection');
        if (metaGeralSection) {
          metaGeralSection.classList.remove("hidden");
        }
        // Mostrar seção de meta geral de grid para administradores
        const metaGeralGridSection = document.getElementById('metaGeralGridAdminSection');
        if (metaGeralGridSection) {
          metaGeralGridSection.classList.remove("hidden");
        }
        // Mostrar seção de adicionar dados diários para administradores
        const rankingFormSection = document.getElementById("rankingForm");
        if (rankingFormSection) {
          rankingFormSection.classList.remove("hidden");
        }
      } else {
        document.getElementById("adminPanel").classList.add("hidden");
        document.getElementById("adminBackupBtn").style.display = "none";
        document.getElementById("toggleBackupAutoSpan").style.display = "none";
        document.getElementById("tabelasRanking").style.display = "none";
        document.getElementById("posicaoUsuario").style.display = "block";
        // Esconder seção de meta geral para funcionários
        const metaGeralSection = document.getElementById("metaGeralAdminSection");
        if (metaGeralSection) {
          metaGeralSection.classList.add("hidden");
        }
        // Esconder seção de meta geral de grid para funcionários
        const metaGeralGridSection = document.getElementById("metaGeralGridAdminSection");
        if (metaGeralGridSection) {
          metaGeralGridSection.classList.add("hidden");
        }
        // Esconder seção de adicionar dados diários para funcionários
        const rankingFormSection = document.getElementById("rankingForm");
        if (rankingFormSection) {
          rankingFormSection.classList.add("hidden");
        }
      }

      // Carregar dados do Firebase após login bem-sucedido
      await carregarDadosDoFirebase();

      // Inicializar meta geral com prioridade do Firebase
      inicializarMetaGeral().then(() => {
        // Após carregar a meta, atualizar as tabelas de metas se necessário
        if (document.getElementById("metasContent").classList.contains("active")) {
          atualizarTabelasMetas();
        }
      });

      desenharCalendarios();
      preencherFiltroMes();
      atualizarTabelasRanking();
      atualizarListaFolgas();
      preencherListaUsuarios();
      preencherUsuariosRanking();
      backupAutomaticoSeAtivo();
    } else {
      alert('Login ou senha incorretos!');
    }
  }

  // Função para ler folgas do Firebase
  async function lerFolgasDoFirebase() {
    try {
      const snapshot = await db.collection("folgas").get();
      const folgas = {};
      snapshot.forEach(doc => {
        folgas[doc.id] = doc.data().datas || [];
      });
      return folgas;
    } catch (error) {
      console.error("Erro ao ler folgas do Firebase:", error);
      return null;
    }
  }

  // Função para ler ranking do Firebase
  async function lerRankingDoFirebase() {
    try {
      const snapshot = await db.collection("ranking").get();
      const ranking = {};
      snapshot.forEach(doc => {
        ranking[doc.id] = doc.data().registros || {};
      });
      return ranking;
    } catch (error) {
      console.error("Erro ao ler ranking do Firebase:", error);
      return null;
    }
  }

  // Função para carregar todos os dados do Firebase
  async function carregarDadosDoFirebase() {
    try {
      // Carregar folgas do Firebase
      const folgasFirebase = await lerFolgasDoFirebase();
      if (folgasFirebase) {
        console.log("Folgas carregadas do Firebase");
        localStorage.setItem('folgas', JSON.stringify(folgasFirebase));
      } else {
        console.log("Mantendo folgas do localStorage");
      }

      // Carregar ranking do Firebase
      const rankingFirebase = await lerRankingDoFirebase();
      if (rankingFirebase) {
        console.log("Ranking carregado do Firebase");
        localStorage.setItem('ranking', JSON.stringify(rankingFirebase));
      } else {
        console.log("Mantendo ranking do localStorage");
      }
    } catch (error) {
      console.error("Erro ao carregar dados do Firebase:", error);
    }
  }

  function logout() {
    usuarioLogado = null;
    document.getElementById('loginDiv').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    document.getElementById('botaoSairTopo').style.display = 'none';
    document.getElementById('login').value = '';
    document.getElementById('senha').value = '';
    // Esconder seção de meta geral no logout
    const metaGeralSection = document.getElementById('metaGeralAdminSection');
    if (metaGeralSection) {
      metaGeralSection.classList.add("hidden");
    }
    // Esconder seção de meta geral de grid no logout
    const metaGeralGridSection = document.getElementById('metaGeralGridAdminSection');
    if (metaGeralGridSection) {
      metaGeralGridSection.classList.add("hidden");
    }
    // Esconder seção de adicionar dados diários no logout
    const rankingFormSection = document.getElementById("rankingForm");
    if (rankingFormSection) {
      rankingFormSection.classList.add("hidden");
    }
  }

  function cadastrarUsuario() {
    const login = document.getElementById('novoLogin').value;
    const senha = document.getElementById('novaSenha').value;
    const tipo = document.getElementById('novoTipo').value;
    const turno = document.getElementById('novoTurno').value;

    if (!login || !senha) {
      alert('Preencha todos os campos!');
      return;
    }

    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    if (usuarios.some(u => u.login.toLowerCase() === login.toLowerCase())) {
      alert('Login já existe!');
      return;
    }

    usuarios.push({ login, senha, tipo, turno });
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    alert('Usuário cadastrado com sucesso!');
    document.getElementById('novoLogin').value = '';
    document.getElementById('novaSenha').value = '';
    preencherListaUsuarios();
    preencherUsuariosRanking();
    backupAutomaticoSeAtivo();
  }

  function preencherListaUsuarios() {
    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    const select = document.getElementById('listaUsuariosSelect');
    const selectFolga = document.getElementById('usuarioFolgaSelect');
    const selectEditarFolga = document.getElementById('usuarioEditarFolgaSelect');
    const selectVisualizarFuncionario = document.getElementById('visualizarFuncionarioSelect');

    // Limpar selects
    select.innerHTML = '';
    selectFolga.innerHTML = '';
    selectEditarFolga.innerHTML = '';
    selectVisualizarFuncionario.innerHTML = '';

    // Preencher selects
    usuarios.forEach(usuario => {
      // Select de lista de usuários
      const option = document.createElement('option');
      option.value = usuario.login;
      option.textContent = `${usuario.login} (${usuario.tipo}, ${usuario.turno === 'manha' ? 'Manhã' : 'Tarde'})`;
      select.appendChild(option);

      // Select de folga
      const optionFolga = document.createElement('option');
      optionFolga.value = usuario.login;
      optionFolga.textContent = usuario.login;
      selectFolga.appendChild(optionFolga);

      // Select de editar folga
      const optionEditarFolga = document.createElement('option');
      optionEditarFolga.value = usuario.login;
      optionEditarFolga.textContent = usuario.login;
      selectEditarFolga.appendChild(optionEditarFolga);

      // Select de visualizar funcionário
      const optionVisualizarFuncionario = document.createElement('option');
      optionVisualizarFuncionario.value = usuario.login;
      optionVisualizarFuncionario.textContent = usuario.login;
      selectVisualizarFuncionario.appendChild(optionVisualizarFuncionario);
    });

    // Inicializar selects
    if (select.options.length > 0) {
      select.selectedIndex = 0;
      selectFolga.selectedIndex = 0;
      selectEditarFolga.selectedIndex = 0;
      selectVisualizarFuncionario.selectedIndex = 0;
      popularFolgasParaEdicao();
    }
  }

  function alterarUsuario() {
    const login = document.getElementById('listaUsuariosSelect').value;
    const novoLogin = document.getElementById('editarLogin').value;
    const novaSenha = document.getElementById('editarSenha').value;
    const novoTipo = document.getElementById('editarTipo').value;
    const novoTurno = document.getElementById('editarTurno').value;

    if (!login) {
      alert('Selecione um usuário!');
      return;
    }

    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    const index = usuarios.findIndex(u => u.login === login);
    if (index === -1) {
      alert('Usuário não encontrado!');
      return;
    }

    // Verificar se o novo login já existe (exceto se for o mesmo)
    if (novoLogin && novoLogin !== login && usuarios.some(u => u.login.toLowerCase() === novoLogin.toLowerCase())) {
      alert('Novo login já existe!');
      return;
    }

    // Atualizar usuário
    if (novoLogin) usuarios[index].login = novoLogin;
    if (novaSenha) usuarios[index].senha = novaSenha;
    if (novoTipo) usuarios[index].tipo = novoTipo;
    if (novoTurno) usuarios[index].turno = novoTurno;

    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    alert('Usuário alterado com sucesso!');
    document.getElementById('editarLogin').value = '';
    document.getElementById('editarSenha').value = '';
    preencherListaUsuarios();
    preencherUsuariosRanking();
    backupAutomaticoSeAtivo();
  }

  function removerUsuario() {
    const login = document.getElementById('listaUsuariosSelect').value;
    if (!login) {
      alert('Selecione um usuário!');
      return;
    }

    if (!confirm(`Tem certeza que deseja remover o usuário ${login}?`)) {
      return;
    }

    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    const index = usuarios.findIndex(u => u.login === login);
    if (index === -1) {
      alert('Usuário não encontrado!');
      return;
    }

    usuarios.splice(index, 1);
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    alert('Usuário removido com sucesso!');
    preencherListaUsuarios();
    preencherUsuariosRanking();
    backupAutomaticoSeAtivo();
  }

  function alterarSenha() {
    const novaSenha = document.getElementById('novaSenhaUsuario').value;
    if (!novaSenha) {
      alert('Digite a nova senha!');
      return;
    }

    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    const index = usuarios.findIndex(u => u.login === usuarioLogado.login);
    if (index === -1) {
      alert('Erro ao alterar senha!');
      return;
    }

    usuarios[index].senha = novaSenha;
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    usuarioLogado.senha = novaSenha;
    alert('Senha alterada com sucesso!');
    document.getElementById('novaSenhaUsuario').value = '';
    backupAutomaticoSeAtivo();
  }

  function atribuirFolga() {
    const login = document.getElementById('usuarioFolgaSelect').value;
    const datasStr = document.getElementById('folgaAdminData').value;

    if (!login || !datasStr) {
      alert('Selecione um usuário e pelo menos uma data!');
      return;
    }

    const datas = datasStr.split(',').map(d => d.trim());
    if (datas.length === 0) {
      alert('Selecione pelo menos uma data!');
      return;
    }

    // Obter folgas existentes
    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    if (!folgas[login]) {
      folgas[login] = [];
    }

    // Adicionar novas folgas
    datas.forEach(data => {
      if (!folgas[login].includes(data)) {
        folgas[login].push(data);
      }
    });

    // Salvar folgas
    localStorage.setItem('folgas', JSON.stringify(folgas));
    alert('Folga(s) atribuída(s) com sucesso!');
    document.getElementById('folgaAdminData').value = '';
    atualizarListaFolgas();
    desenharCalendarios();
    desenharCalendariosFuncionario();
    atualizarCalendarioFolgas();
    backupAutomaticoSeAtivo();
  }

  function popularFolgasParaEdicao() {
    const login = document.getElementById('usuarioEditarFolgaSelect').value;
    const select = document.getElementById('dataFolgaEditarSelect');
    select.innerHTML = '';

    if (!login) return;

    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const datasUsuario = folgas[login] || [];

    if (datasUsuario.length === 0) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Nenhuma folga cadastrada';
      select.appendChild(option);
      return;
    }

    // Ordenar datas
    datasUsuario.sort();

    // Preencher select
    datasUsuario.forEach(data => {
      const option = document.createElement('option');
      option.value = data;
      option.textContent = formatarData(data);
      select.appendChild(option);
    });
  }

  function editarFolga() {
    const login = document.getElementById('usuarioEditarFolgaSelect').value;
    const dataAntiga = document.getElementById('dataFolgaEditarSelect').value;
    const dataNova = document.getElementById('novaDataFolgaInput').value;

    if (!login || !dataAntiga || !dataNova) {
      alert('Preencha todos os campos!');
      return;
    }

    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    if (!folgas[login]) {
      alert('Usuário não possui folgas!');
      return;
    }

    const index = folgas[login].indexOf(dataAntiga);
    if (index === -1) {
      alert('Folga não encontrada!');
      return;
    }

    // Verificar se a nova data já existe
    if (folgas[login].includes(dataNova)) {
      alert('Usuário já possui folga nesta data!');
      return;
    }

    // Atualizar folga
    folgas[login][index] = dataNova;
    localStorage.setItem('folgas', JSON.stringify(folgas));
    alert('Folga editada com sucesso!');
    document.getElementById('novaDataFolgaInput').value = '';
    popularFolgasParaEdicao();
    atualizarListaFolgas();
    desenharCalendarios();
    desenharCalendariosFuncionario();
    atualizarCalendarioFolgas();
    backupAutomaticoSeAtivo();
  }

  function excluirFolga() {
    const login = document.getElementById('usuarioEditarFolgaSelect').value;
    const data = document.getElementById('dataFolgaEditarSelect').value;

    if (!login || !data) {
      alert('Selecione um usuário e uma data!');
      return;
    }

    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    if (!folgas[login]) {
      alert('Usuário não possui folgas!');
      return;
    }

    const index = folgas[login].indexOf(data);
    if (index === -1) {
      alert('Folga não encontrada!');
      return;
    }

    // Remover folga
    folgas[login].splice(index, 1);
    localStorage.setItem('folgas', JSON.stringify(folgas));
    alert('Folga excluída com sucesso!');
    popularFolgasParaEdicao();
    atualizarListaFolgas();
    desenharCalendarios();
    desenharCalendariosFuncionario();
    atualizarCalendarioFolgas();
    backupAutomaticoSeAtivo();
  }

  function atualizarListaFolgas() {
    const div = document.getElementById('listaFolgas');
    div.innerHTML = '';

    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const usuarios = Object.keys(folgas);

    if (usuarios.length === 0) {
      div.textContent = 'Nenhuma folga cadastrada.';
      return;
    }

    // Ordenar usuários
    usuarios.sort();

    // Criar lista de folgas
    usuarios.forEach(usuario => {
      const datasUsuario = folgas[usuario] || [];
      if (datasUsuario.length === 0) return;

      // Ordenar datas
      datasUsuario.sort();

      const p = document.createElement('p');
      p.innerHTML = `<strong>${usuario}</strong>: ${datasUsuario.map(d => formatarData(d)).join(', ')}`;
      div.appendChild(p);
    });
  }

  function formatarData(dataStr) {
    const data = new Date(dataStr);
    return data.toLocaleDateString('pt-BR');
  }

  function desenharCalendarios() {
    const div = document.getElementById('calendarios');
    div.innerHTML = '';

    // Obter folgas do usuário logado
    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const datasUsuario = folgas[usuarioLogado.login] || [];

    // Obter ano atual
    const anoAtual = new Date().getFullYear();

    // Criar calendários para cada mês
    for (let mes = 0; mes < 12; mes++) {
      const divMes = document.createElement('div');
      divMes.className = 'mesTitulo';
      divMes.textContent = obterNomeMes(mes);
      div.appendChild(divMes);

      // Criar tabela do mês
      const tabela = document.createElement('table');
      
      // Cabeçalho da tabela
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(dia => {
        const th = document.createElement('th');
        th.textContent = dia;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      tabela.appendChild(thead);

      // Corpo da tabela
      const tbody = document.createElement('tbody');
      
      // Obter primeiro dia do mês e total de dias
      const primeiroDia = new Date(anoAtual, mes, 1);
      const ultimoDia = new Date(anoAtual, mes + 1, 0);
      const totalDias = ultimoDia.getDate();
      
      // Obter dia da semana do primeiro dia (0 = Domingo, 6 = Sábado)
      const diaSemana = primeiroDia.getDay();
      
      // Criar linhas do calendário
      let dia = 1;
      for (let i = 0; i < 6; i++) {
        const tr = document.createElement('tr');
        
        // Criar células
        for (let j = 0; j < 7; j++) {
          const td = document.createElement('td');
          
          // Verificar se é um dia válido
          if ((i === 0 && j < diaSemana) || dia > totalDias) {
            // Célula vazia
            td.textContent = '';
          } else {
            // Célula com dia
            td.textContent = dia;
            
            // Verificar se é um dia de folga
            const dataStr = `${anoAtual}-${(mes + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
            if (datasUsuario.includes(dataStr)) {
              td.className = 'folga';
            }
            
            dia++;
          }
          
          tr.appendChild(td);
        }
        
        tbody.appendChild(tr);
        
        // Verificar se já mostrou todos os dias
        if (dia > totalDias) break;
      }
      
      tabela.appendChild(tbody);
      div.appendChild(tabela);
    }
  }

  function desenharCalendariosFuncionario() {
    const div = document.getElementById('calendarioFuncionario');
    div.innerHTML = '';

    // Obter usuário selecionado
    const login = document.getElementById('visualizarFuncionarioSelect').value;
    if (!login) return;

    // Obter folgas do usuário
    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const datasUsuario = folgas[login] || [];

    // Obter ano atual
    const anoAtual = new Date().getFullYear();

    // Criar calendários para cada mês
    for (let mes = 0; mes < 12; mes++) {
      const divMes = document.createElement('div');
      divMes.className = 'mesTitulo';
      divMes.textContent = obterNomeMes(mes);
      div.appendChild(divMes);

      // Criar tabela do mês
      const tabela = document.createElement('table');
      
      // Cabeçalho da tabela
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(dia => {
        const th = document.createElement('th');
        th.textContent = dia;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      tabela.appendChild(thead);

      // Corpo da tabela
      const tbody = document.createElement('tbody');
      
      // Obter primeiro dia do mês e total de dias
      const primeiroDia = new Date(anoAtual, mes, 1);
      const ultimoDia = new Date(anoAtual, mes + 1, 0);
      const totalDias = ultimoDia.getDate();
      
      // Obter dia da semana do primeiro dia (0 = Domingo, 6 = Sábado)
      const diaSemana = primeiroDia.getDay();
      
      // Criar linhas do calendário
      let dia = 1;
      for (let i = 0; i < 6; i++) {
        const tr = document.createElement('tr');
        
        // Criar células
        for (let j = 0; j < 7; j++) {
          const td = document.createElement('td');
          
          // Verificar se é um dia válido
          if ((i === 0 && j < diaSemana) || dia > totalDias) {
            // Célula vazia
            td.textContent = '';
          } else {
            // Célula com dia
            td.textContent = dia;
            
            // Verificar se é um dia de folga
            const dataStr = `${anoAtual}-${(mes + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
            if (datasUsuario.includes(dataStr)) {
              td.className = 'folga';
            }
            
            dia++;
          }
          
          tr.appendChild(td);
        }
        
        tbody.appendChild(tr);
        
        // Verificar se já mostrou todos os dias
        if (dia > totalDias) break;
      }
      
      tabela.appendChild(tbody);
      div.appendChild(tabela);
    }
  }

  function obterNomeMes(mes) {
    const meses = [
      'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    return meses[mes];
  }

  // Funções para o ranking
  function preencherUsuariosRanking() {
    const usuarios = JSON.parse(localStorage.getItem('usuarios'));
    const select = document.getElementById('usuarioRankingSelect');
    select.innerHTML = '';

    // Filtrar apenas funcionários se o usuário logado for funcionário
    const usuariosFiltrados = usuarioLogado.tipo === 'admin' 
      ? usuarios 
      : usuarios.filter(u => u.login === usuarioLogado.login);

    // Preencher select
    usuariosFiltrados.forEach(usuario => {
      const option = document.createElement('option');
      option.value = usuario.login;
      option.textContent = usuario.login;
      select.appendChild(option);
    });

    // Selecionar usuário logado por padrão
    if (usuarioLogado.tipo !== 'admin') {
      select.value = usuarioLogado.login;
    }
  }

  function preencherFiltroMes() {
    const select = document.getElementById('filtroMesSelect');
    select.innerHTML = '';

    // Adicionar opção para todos os meses
    const optionTodos = document.createElement('option');
    optionTodos.value = 'todos';
    optionTodos.textContent = 'Todos os Meses';
    select.appendChild(optionTodos);

    // Adicionar opções para cada mês
    const meses = [
      'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    meses.forEach((mes, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = mes;
      select.appendChild(option);
    });

    // Selecionar mês atual por padrão
    const mesAtual = new Date().getMonth();
    select.value = mesAtual;
  }

  function preencherFiltroMesMetas() {
    const select = document.getElementById('filtroMesMetas');
    select.innerHTML = '';

    // Adicionar opção para todos os meses
    const optionTodos = document.createElement('option');
    optionTodos.value = 'todos';
    optionTodos.textContent = 'Todos os Meses';
    select.appendChild(optionTodos);

    // Adicionar opções para cada mês
    const meses = [
      'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    meses.forEach((mes, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = mes;
      select.appendChild(option);
    });

    // Selecionar mês atual por padrão
    const mesAtual = new Date().getMonth();
    select.value = mesAtual;
    
    // Atualizar meta ao mudar o mês no filtro
    select.onchange = function() {
      atualizarTabelasMetas();
    };
  }

  // Função para preencher o filtro de mês das metas de grid
  function preencherFiltroMesMetasGrid() {
    const select = document.getElementById('filtroMesMetasGrid');
    select.innerHTML = '';

    // Adicionar opção para todos os meses
    const optionTodos = document.createElement('option');
    optionTodos.value = 'todos';
    optionTodos.textContent = 'Todos os Meses';
    select.appendChild(optionTodos);

    // Adicionar opções para cada mês
    const meses = [
      'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    meses.forEach((mes, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = mes;
      select.appendChild(option);
    });

    // Selecionar mês atual por padrão
    const mesAtual = new Date().getMonth();
    select.value = mesAtual;
    
    // Atualizar meta ao mudar o mês no filtro
    select.onchange = function() {
      atualizarTabelasMetasGrid();
    };
  }

  function adicionarDadosRanking() {
    const login = document.getElementById('usuarioRankingSelect').value;
    const data = document.getElementById('dataRanking').value;
    const totalVendas = parseInt(document.getElementById('totalVendas').value) || 0;
    const totalAbastecimentos = parseInt(document.getElementById('totalAbastecimentos').value) || 0;
    const totalGrid = parseInt(document.getElementById('totalGrid').value) || 0;

    if (!login || !data) {
      alert('Selecione um usuário e uma data!');
      return;
    }

    // Obter ranking existente
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    if (!ranking[login]) {
      ranking[login] = {};
    }

    // Adicionar ou atualizar dados, preservando valores existentes se não forem fornecidos novos
    const dadosExistentes = ranking[login][data] || { vendas: 0, abastecimentos: 0, grid: 0 };
    const novasVendasInput = document.getElementById('totalVendas').value;
    const novosAbastecimentosInput = document.getElementById('totalAbastecimentos').value;
    const novoGridInput = document.getElementById('totalGrid').value;

    // Usa o novo valor se fornecido, senão mantém o existente
    const finalVendas = novasVendasInput !== '' ? (parseInt(novasVendasInput) || 0) : dadosExistentes.vendas;
    const finalAbastecimentos = novosAbastecimentosInput !== '' ? (parseInt(novosAbastecimentosInput) || 0) : dadosExistentes.abastecimentos;
    const finalGrid = novoGridInput !== '' ? (parseInt(novoGridInput) || 0) : dadosExistentes.grid;

    ranking[login][data] = {
      vendas: finalVendas,
      abastecimentos: finalAbastecimentos,
      grid: finalGrid
    };

    // Salvar ranking
    localStorage.setItem('ranking', JSON.stringify(ranking));
    alert('Dados adicionados com sucesso!');
    document.getElementById('totalVendas').value = '';
    document.getElementById('totalAbastecimentos').value = '';
    document.getElementById('totalGrid').value = '';
    atualizarTabelasRanking();
    backupAutomaticoSeAtivo();
  }

  function atualizarTabelasRanking() {
    // Limpar tabelas
    document.getElementById('rankingManhaTbody').innerHTML = '';
    document.getElementById('rankingTardeTbody').innerHTML = '';

    // Obter filtros
    const filtroTurno = document.getElementById('filtroTurnoSelect').value;
    const filtroMes = document.getElementById('filtroMesSelect').value;
    const ordenacaoPor = document.getElementById('ordenacaoRankingSelect').value;

    // Obter dados
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');

    // Calcular totais por usuário
    const totais = {};
    
    usuarios.forEach(usuario => {
      const login = usuario.login;
      const turno = usuario.turno;
      
      // Inicializar totais
      totais[login] = {
        login,
        turno,
        totalVendas: 0,
        totalAbastecimentos: 0,
        totalGrid: 0
      };
      
      // Somar dados do usuário
      const dadosUsuario = ranking[login] || {};
      
      Object.entries(dadosUsuario).forEach(([data, valores]) => {
        // Verificar filtro de mês
        if (filtroMes !== 'todos') {
          const dataObj = new Date(data + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário
          const mes = dataObj.getMonth();
          if (mes !== parseInt(filtroMes)) return;
        }
        
        // Somar valores
        const totalVendasDia = valores.vendas || 0;
        const totalAbastecimentosDia = valores.abastecimentos || 0;
        const totalGridDia = valores.grid || 0;
        
        totais[login].totalVendas += totalVendasDia;
        totais[login].totalAbastecimentos += totalAbastecimentosDia;
        totais[login].totalGrid += totalGridDia;
      });
    });
    
    // Ordenar usuários conforme seleção (vendas, abastecimentos ou grid)
    let compararPor;
    if (ordenacaoPor === "vendas") {
      compararPor = (a, b) => b.totalVendas - a.totalVendas;
    } else if (ordenacaoPor === "abastecimentos") {
      compararPor = (a, b) => b.totalAbastecimentos - a.totalAbastecimentos;
    } else {
      compararPor = (a, b) => b.totalGrid - a.totalGrid;
    }
    
    // Filtrar usuários por turno APÓS calcular os totais mensais
    const usuariosManha = Object.values(totais)
      .filter(u => u.turno === "manha")
      .sort(compararPor);
      
    const usuariosTarde = Object.values(totais)
      .filter(u => u.turno === "tarde")
      .sort(compararPor);
    
    // Se for funcionário, mostrar apenas sua posição no ranking do mês
    if (usuarioLogado && usuarioLogado.tipo !== "admin") {
      // Determinar a lista de usuários a ser considerada com base no filtro de turno
      let usuariosParaComparacao = [];
      if (filtroTurno === "todos") {
        usuariosParaComparacao = [...usuariosManha, ...usuariosTarde];
      } else if (filtroTurno === "manha") {
        usuariosParaComparacao = usuariosManha;
      } else if (filtroTurno === "tarde") {
        usuariosParaComparacao = usuariosTarde;
      }

      // Ordenar a lista filtrada por turno para encontrar a posição
      const usuariosFiltradosVendas = [...usuariosParaComparacao].sort((a, b) => b.totalVendas - a.totalVendas);
      const usuariosFiltradosAbastecimentos = [...usuariosParaComparacao].sort((a, b) => b.totalAbastecimentos - a.totalAbastecimentos);
      const usuariosFiltradosGrid = [...usuariosParaComparacao].sort((a, b) => b.totalGrid - a.totalGrid);
      
      // Encontrar posição do usuário na lista filtrada
      const posicaoVendas = usuariosFiltradosVendas.findIndex(u => u.login === usuarioLogado.login) + 1;
      const posicaoAbastecimentos = usuariosFiltradosAbastecimentos.findIndex(u => u.login === usuarioLogado.login) + 1;
      const posicaoGrid = usuariosFiltradosGrid.findIndex(u => u.login === usuarioLogado.login) + 1;
      
      // Atualizar informações na interface
      const dadosUsuarioMes = totais[usuarioLogado.login] || { totalVendas: 0, totalAbastecimentos: 0 };
      
      // Mostrar posição apenas se o usuário estiver no turno filtrado (ou se o filtro for 'todos')
      // E se o usuário tiver dados no período
      let textoPosicaoVendas = "Sem classificação";
      let textoPosicaoAbastecimentos = "Sem classificação";

      if (filtroTurno === 'todos' || usuarioLogado.turno === filtroTurno) {
          if (posicaoVendas > 0 && dadosUsuarioMes.totalVendas > 0) {
              textoPosicaoVendas = `${posicaoVendas}º lugar (no turno ${filtroTurno === 'todos' ? 'geral' : filtroTurno})`;
          }
          if (posicaoAbastecimentos > 0 && dadosUsuarioMes.totalAbastecimentos > 0) {
              textoPosicaoAbastecimentos = `${posicaoAbastecimentos}º lugar (no turno ${filtroTurno === 'todos' ? 'geral' : filtroTurno})`;
          }
          if (posicaoGrid > 0 && dadosUsuarioMes.totalGrid > 0) {
              const textoPosicaoGrid = `${posicaoGrid}º lugar (no turno ${filtroTurno === 'todos' ? 'geral' : filtroTurno})`;
              // Podemos adicionar um elemento para mostrar a posição do grid se necessário, 
              // mas por enquanto vamos apenas garantir que os dados estejam disponíveis.
          }
      } else {
          textoPosicaoVendas = "Fora do turno filtrado";
          textoPosicaoAbastecimentos = "Fora do turno filtrado";
      }

      document.getElementById("posicaoVendas").textContent = textoPosicaoVendas;
      document.getElementById("posicaoAbastecimentos").textContent = textoPosicaoAbastecimentos;
      document.getElementById("totalVendasUsuario").textContent = dadosUsuarioMes.totalVendas;
      document.getElementById("totalAbastecimentosUsuario").textContent = dadosUsuarioMes.totalAbastecimentos;
      document.getElementById("totalGridUsuario").textContent = dadosUsuarioMes.totalGrid;
      
      // Atualizar dados detalhados também para o funcionário
      atualizarDadosDetalhadosDiarios(); // Chamada mantida aqui
      
      return; // Não precisa preencher as tabelas para funcionários
    }
    
    // Para administradores, preencher tabelas completas com dados mensais
    // Preencher tabela da manhã
    const tbodyManha = document.getElementById("rankingManhaTbody");
    if (filtroTurno === "todos" || filtroTurno === "manha") {
      const usuariosManhaComDados = usuariosManha.filter(u => u.totalVendas > 0 || u.totalAbastecimentos > 0 || u.totalGrid > 0);
      if (usuariosManhaComDados.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="4">Nenhum dado disponível para este filtro</td>';
        tbodyManha.appendChild(tr);
      } else {
        usuariosManhaComDados.forEach(usuario => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${usuario.login}</td>
            <td>${usuario.totalVendas}</td>
            <td>${usuario.totalAbastecimentos}</td>
            <td>${usuario.totalGrid}</td>
          `;
          tbodyManha.appendChild(tr);
        });
      }
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="4">Filtro aplicado para outro turno</td>';
      tbodyManha.appendChild(tr);
    }
    
    // Preencher tabela da tarde
    const tbodyTarde = document.getElementById("rankingTardeTbody");
    if (filtroTurno === "todos" || filtroTurno === "tarde") {
      const usuariosTardeComDados = usuariosTarde.filter(u => u.totalVendas > 0 || u.totalAbastecimentos > 0 || u.totalGrid > 0);
      if (usuariosTardeComDados.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td colspan="4">Nenhum dado disponível para este filtro</td>';
        tbodyTarde.appendChild(tr);
      } else {
        usuariosTardeComDados.forEach(usuario => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${usuario.login}</td>
            <td>${usuario.totalVendas}</td>
            <td>${usuario.totalAbastecimentos}</td>
            <td>${usuario.totalGrid}</td>
          `;
          tbodyTarde.appendChild(tr);
        });
      }
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="4">Filtro aplicado para outro turno</td>';
      tbodyTarde.appendChild(tr);
    }
    
    // Atualizar a lista de dados detalhados
    atualizarDadosDetalhadosDiarios(); // Chamada adicionada aqui
  }
  
  // Função para atualizar o calendário de folgas (nova aba)
  function atualizarCalendarioFolgas() {
    const divCalendario = document.getElementById('calendarioFolgas');
    divCalendario.innerHTML = '';
    
    // Obter mês, ano e turno selecionados
    const mesSelecionado = document.getElementById('filtroMesCalendario').value;
    const ano = parseInt(document.getElementById('filtroAnoCalendario').value);
    const turnoFiltro = document.getElementById('filtroTurnoCalendario').value;
    
    // Obter folgas de todos os usuários
    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
    
    // Determinar quais meses exibir
    const mesesParaExibir = mesSelecionado === 'todos' 
      ? Array.from({length: 12}, (_, i) => i) // Todos os meses (0-11)
      : [parseInt(mesSelecionado)]; // Apenas o mês selecionado
    
    // Para cada mês a ser exibido
    mesesParaExibir.forEach(mes => {
      // Criar div do mês
      const divMes = document.createElement('div');
      divMes.className = 'calendario-mes';
      
      // Adicionar título do mês
      const h3 = document.createElement('h3');
      h3.textContent = `${obterNomeMes(mes)} de ${ano}`;
      divMes.appendChild(h3);
      
      // Criar grid do calendário
      const divGrid = document.createElement('div');
      divGrid.className = 'calendario-grid';
      
      // Adicionar cabeçalhos dos dias da semana
      const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
      diasSemana.forEach(dia => {
        const divDia = document.createElement('div');
        divDia.className = 'dia-header';
        divDia.textContent = dia;
        divGrid.appendChild(divDia);
      });
      
      // Obter primeiro dia do mês e total de dias
      const primeiroDia = new Date(ano, mes, 1);
      const ultimoDia = new Date(ano, mes + 1, 0);
      const totalDias = ultimoDia.getDate();
      
      // Obter dia da semana do primeiro dia (0 = Domingo, 6 = Sábado)
      const diaSemana = primeiroDia.getDay();
      
      // Adicionar células vazias para os dias antes do início do mês
      for (let i = 0; i < diaSemana; i++) {
        const divCelula = document.createElement('div');
        divCelula.className = 'dia-celula dia-vazio';
        divGrid.appendChild(divCelula);
      }
      
      // Data atual para destacar o dia de hoje
      const hoje = new Date();
      const diaHoje = hoje.getDate();
      const mesHoje = hoje.getMonth();
      const anoHoje = hoje.getFullYear();
      
      // Adicionar células para cada dia do mês
      for (let dia = 1; dia <= totalDias; dia++) {
        const divCelula = document.createElement('div');
        divCelula.className = 'dia-celula';
        
        // Destacar o dia de hoje
        if (dia === diaHoje && mes === mesHoje && ano === anoHoje) {
          divCelula.classList.add('hoje');
        }
        
        // Adicionar número do dia
        const divNumero = document.createElement('div');
        divNumero.className = 'dia-numero';
        divNumero.textContent = dia;
        divCelula.appendChild(divNumero);
        
        // Adicionar div para folgas
        const divFolgas = document.createElement('div');
        divFolgas.className = 'dia-folgas';
        
        // Verificar quais funcionários estão de folga neste dia
        const dataStr = `${ano}-${(mes + 1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
        const funcionariosFolga = [];
        
        Object.entries(folgas).forEach(([login, datas]) => {
          if (datas.includes(dataStr)) {
            // Encontrar informações do usuário
            const usuario = usuarios.find(u => u.login === login);
            if (usuario) {
              // Aplicar filtro de turno
              if (turnoFiltro === 'todos' || usuario.turno === turnoFiltro) {
                funcionariosFolga.push({
                  login,
                  turno: usuario.turno
                });
              }
            } else {
              // Se não encontrar o usuário e o filtro for 'todos', incluir mesmo assim
              if (turnoFiltro === 'todos') {
                funcionariosFolga.push({
                  login,
                  turno: 'desconhecido'
                });
              }
            }
          }
        });
        
        // Ordenar funcionários por turno e depois por login
        funcionariosFolga.sort((a, b) => {
          if (a.turno === b.turno) {
            return a.login.localeCompare(b.login);
          }
          return a.turno === 'manha' ? -1 : 1;
        });
        
        // Adicionar spans para cada funcionário de folga
        funcionariosFolga.forEach(funcionario => {
          const span = document.createElement('span');
          span.textContent = `${funcionario.login} (${funcionario.turno === 'manha' ? 'Manhã' : 'Tarde'})`;
          divFolgas.appendChild(span);
        });
        
        divCelula.appendChild(divFolgas);
      divGrid.appendChild(divCelula);
    }
    
    // Adicionar células vazias para completar a última semana
    const diasRestantes = 7 - ((diaSemana + totalDias) % 7);
    if (diasRestantes < 7) {
      for (let i = 0; i < diasRestantes; i++) {
        const divCelula = document.createElement('div');
        divCelula.className = 'dia-celula dia-vazio';
        divGrid.appendChild(divCelula);
      }
    }
    
    divMes.appendChild(divGrid);
    divCalendario.appendChild(divMes);
    });
  }
  
  async function backupParaFirebase() {
    // Obter todos os dados do sistema
    const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
    const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    const metaGeral = localStorage.getItem('metaGeral') || '1000'; // Incluir meta geral no backup
    const metasVendasMensais = JSON.parse(localStorage.getItem('metasVendasMensais') || '{}');
    const metasGridMensais = JSON.parse(localStorage.getItem('metasGridMensais') || '{}');

    try {
      // Salvar dados no Firebase
      await salvarUsuariosNoFirebase(usuarios);
      await salvarFolgasNoFirebase(folgas);
      await salvarRankingNoFirebase(ranking);
      await salvarMetaGeralNoFirebase(metaGeral); // Nova função para salvar meta geral
      await salvarMetasVendasMensaisNoFirebase(metasVendasMensais);
      await salvarMetasGridMensaisNoFirebase(metasGridMensais);
      
      alert('Backup realizado com sucesso no Firebase!');
    } catch (error) {
      console.error('Erro ao fazer backup:', error);
      alert('Erro ao fazer backup: ' + error.message);
    }
  }

  async function salvarUsuariosNoFirebase(usuarios) {
    const batch = db.batch();
    for (const usuario of usuarios) {
      const ref = db.collection("usuarios").doc(usuario.login);
      batch.set(ref, usuario);
    }
    await batch.commit();
  }

  async function salvarFolgasNoFirebase(folgas) {
    const batch = db.batch();
    for (const [usuario, datas] of Object.entries(folgas)) {
      const ref = db.collection("folgas").doc(usuario);
      batch.set(ref, { datas });
    }
    await batch.commit();
  }

  async function salvarRankingNoFirebase(ranking) {
    const batch = db.batch();
    for (const [usuario, registros] of Object.entries(ranking)) {
      const ref = db.collection("ranking").doc(usuario);
      batch.set(ref, { registros });
    }
    await batch.commit();
  }

  // Nova função para salvar meta geral no Firebase
  async function salvarMetaGeralNoFirebase(metaGeral) {
    const ref = db.collection("meta").doc("metaGeral");
    await ref.set({ valor: metaGeral });
  }

  async function salvarMetasVendasMensaisNoFirebase(metas) {
    const ref = db.collection("meta").doc("metasVendasMensais");
    await ref.set(metas);
  }

  async function salvarMetasGridMensaisNoFirebase(metas) {
    const ref = db.collection("meta").doc("metasGridMensais");
    await ref.set(metas);
  }

  // Nova função para ler meta geral do Firebase
  async function lerMetaGeralDoFirebase() {
    try {
      const ref = db.collection("meta").doc("metaGeral");
      const doc = await ref.get();
      if (doc.exists) {
        return doc.data().valor;
      } else {
        console.log("Meta geral não encontrada no Firebase");
        return null;
      }
    } catch (error) {
      console.error("Erro ao ler meta geral do Firebase:", error);
      return null;
    }
  }

  async function lerMetasMensaisDoFirebase(tipo) {
    try {
      const ref = db.collection("meta").doc(tipo);
      const doc = await ref.get();
      if (doc.exists) {
        return doc.data();
      } else {
        console.log(tipo + " não encontrada no Firebase");
        return null;
      }
    } catch (error) {
      console.error("Erro ao ler " + tipo + " do Firebase:", error);
      return null;
    }
  }

  // Função para inicializar meta geral com prioridade do Firebase
  async function inicializarMetaGeral() {
    try {
      // Carregar meta geral
      const metaFirebase = await lerMetaGeralDoFirebase();
      if (metaFirebase !== null) {
        localStorage.setItem("metaGeral", metaFirebase);
        console.log("Meta geral carregada do Firebase:", metaFirebase);
      } else if (!localStorage.getItem("metaGeral")) {
        localStorage.setItem("metaGeral", "1000");
      }

      // Carregar metas de vendas mensais
      const metasVendasFirebase = await lerMetasMensaisDoFirebase("metasVendasMensais");
      if (metasVendasFirebase !== null) {
        localStorage.setItem("metasVendasMensais", JSON.stringify(metasVendasFirebase));
        console.log("Metas de vendas mensais carregadas do Firebase");
      }

      // Carregar metas de grid mensais
      const metasGridFirebase = await lerMetasMensaisDoFirebase("metasGridMensais");
      if (metasGridFirebase !== null) {
        localStorage.setItem("metasGridMensais", JSON.stringify(metasGridFirebase));
        console.log("Metas de grid mensais carregadas do Firebase");
      }
    } catch (error) {
      console.error("Erro ao inicializar metas:", error);
      if (!localStorage.getItem("metaGeral")) {
        localStorage.setItem("metaGeral", "1000");
      }
    }
  }

  function alternarTema() {
    document.body.classList.toggle('tema-escuro');
  }

  let backupAutoAtivo = false;

  function alternarBackupAuto() {
    backupAutoAtivo = document.getElementById('toggleBackupAuto').checked;
    console.log("Backup automático está " + (backupAutoAtivo ? "ATIVADO" : "DESATIVADO"));
  }

  async function backupAutomaticoSeAtivo() {
    if (backupAutoAtivo) {
      const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
      const folgas = JSON.parse(localStorage.getItem('folgas') || '{}');
      const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
      const metaGeral = localStorage.getItem('metaGeral') || '1000'; // Incluir meta geral no backup automático
      const metasVendasMensais = JSON.parse(localStorage.getItem('metasVendasMensais') || '{}');
      const metasGridMensais = JSON.parse(localStorage.getItem('metasGridMensais') || '{}');
      try {
        await salvarUsuariosNoFirebase(usuarios);
        await salvarFolgasNoFirebase(folgas);
        await salvarRankingNoFirebase(ranking);
        await salvarMetaGeralNoFirebase(metaGeral); // Salvar meta geral automaticamente
        await salvarMetasVendasMensaisNoFirebase(metasVendasMensais);
        await salvarMetasGridMensaisNoFirebase(metasGridMensais);
        console.log("[Backup automático] Backup realizado após alteração.");
      } catch (e) {
        console.error("[Backup automático] Erro ao fazer backup:", e);
      }
    }
  }

  // Função para atualizar a lista de dados detalhados por dia
  function atualizarDadosDetalhadosDiarios() {
    const divLista = document.getElementById('listaDadosDetalhados');
    divLista.innerHTML = '<p>Carregando dados detalhados...</p>'; // Limpa e mostra carregando

    // Obter filtros
    const filtroTurno = document.getElementById('filtroTurnoSelect').value;
    const filtroMes = document.getElementById('filtroMesSelect').value;

    // Obter dados
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]'); // Necessário para obter turno do admin

    let htmlContent = '';
    let dadosEncontrados = false;

    // Verificar se há usuário logado
    if (!usuarioLogado) {
        divLista.innerHTML = '<p>Erro: Usuário não está logado.</p>';
        return;
    }

    // Função auxiliar para processar dados de um usuário específico
    const processarUsuario = (usuarioLogin, usuarioTurno) => {
        const dadosUsuario = ranking[usuarioLogin] || {};
        const dadosFiltradosUsuario = [];

        // Iterar sobre os dados diários do usuário
        Object.entries(dadosUsuario).forEach(([data, valores]) => {
            const dataObj = new Date(data + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário
            const mesData = dataObj.getMonth();

            // Aplicar filtro de mês
            if (filtroMes === 'todos' || mesData === parseInt(filtroMes)) {
                dadosFiltradosUsuario.push({
                    data: data,
                    vendas: valores.vendas || 0,
                    abastecimentos: valores.abastecimentos || 0,
                    grid: valores.grid || 0
                });
            }
        });

        // Ordenar os dados filtrados por data (mais recente primeiro)
        dadosFiltradosUsuario.sort((a, b) => new Date(b.data) - new Date(a.data));

        // Se houver dados para este usuário após filtrar, adicioná-los ao HTML
        if (dadosFiltradosUsuario.length > 0) {
            dadosEncontrados = true;
            // Para admin, mostrar nome do usuário. Para funcionário, usar "Seus dados".
            if (usuarioLogado.tipo === 'admin') {
                 htmlContent += `<h4>Usuário: ${usuarioLogin} (${usuarioTurno === 'manha' ? 'Manhã' : 'Tarde'})</h4>`;
            } else {
                 htmlContent += `<h4>Seus Dados Detalhados (${usuarioTurno === 'manha' ? 'Manhã' : 'Tarde'})</h4>`;
            }
            
            dadosFiltradosUsuario.forEach(dado => {
                // Formatar data para dd/mm/yyyy
                const [ano, mes, dia] = dado.data.split('-');
                const dataFormatada = `${dia}/${mes}/${ano}`;
                
                htmlContent += `
                    <div class="dados-detalhados-item">
                        <h5>${dataFormatada}</h5>
                        <div class="dados-detalhados-info">
                            <div class="dados-detalhados-valores">
                                Vendas: ${dado.vendas} | Abastecimentos: ${dado.abastecimentos} | Grid: ${dado.grid}
                            </div>
                            ${usuarioLogado.tipo === 'admin' ? `
                            <div class="dados-detalhados-acoes">
                                <button class="btn-editar" onclick="abrirModalEdicao('${usuarioLogin}', '${dado.data}', ${dado.vendas}, ${dado.abastecimentos}, ${dado.grid})">Editar</button>
                                <button class="btn-excluir" onclick="excluirDadosDia('${usuarioLogin}', '${dado.data}')">Excluir</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }
    };

    // Lógica principal baseada no tipo de usuário
    if (usuarioLogado.tipo === 'admin') {
        // Admin: Iterar sobre todos os usuários respeitando o filtro de turno
        usuarios.forEach(usuario => {
            const login = usuario.login;
            const turnoUsuario = usuario.turno;

            // Aplicar filtro de turno
            if (filtroTurno === 'todos' || turnoUsuario === filtroTurno) {
                processarUsuario(login, turnoUsuario);
            }
        });
    } else if (usuarioLogado.tipo === 'funcionario') {
        // Funcionário: Processar apenas os dados do próprio usuário
        // Aplicar filtro de turno (embora geralmente irrelevante para o próprio usuário, mantém consistência)
        if (filtroTurno === 'todos' || usuarioLogado.turno === filtroTurno) {
             processarUsuario(usuarioLogado.login, usuarioLogado.turno);
        }
    }

    // Atualizar o conteúdo da div
    if (dadosEncontrados) {
        divLista.innerHTML = htmlContent;
    } else {
        // Mensagem diferente se for funcionário e não tiver dados
        if (usuarioLogado.tipo === 'funcionario') {
             divLista.innerHTML = '<p>Você ainda não possui dados detalhados para os filtros selecionados.</p>';
        } else {
             divLista.innerHTML = '<p>Nenhum dado detalhado encontrado para os filtros selecionados.</p>';
        }
    }
  }

  // Funções para o modal de edição
  function abrirModalEdicao(usuario, data, vendas, abastecimentos, grid) {
    document.getElementById('modalUsuario').value = usuario;
    document.getElementById('modalData').value = data;
    document.getElementById('modalVendas').value = vendas;
    document.getElementById('modalAbastecimentos').value = abastecimentos;
    document.getElementById('modalGrid').value = grid || 0;
    document.getElementById('modalEdicao').style.display = 'block';
  }

  function fecharModalEdicao() {
    document.getElementById('modalEdicao').style.display = 'none';
  }

  function salvarEdicaoDados() {
    const usuario = document.getElementById('modalUsuario').value;
    const data = document.getElementById('modalData').value;
    const vendas = parseInt(document.getElementById('modalVendas').value) || 0;
    const abastecimentos = parseInt(document.getElementById('modalAbastecimentos').value) || 0;
    const grid = parseInt(document.getElementById('modalGrid').value) || 0;

    if (!usuario || !data) {
      alert('Dados inválidos!');
      return;
    }

    // Obter ranking existente
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    if (!ranking[usuario]) {
      ranking[usuario] = {};
    }

    // Atualizar dados
    ranking[usuario][data] = {
      vendas: vendas,
      abastecimentos: abastecimentos,
      grid: grid
    };

    // Salvar ranking
    localStorage.setItem('ranking', JSON.stringify(ranking));
    alert('Dados editados com sucesso!');
    fecharModalEdicao();
    atualizarTabelasRanking();
    backupAutomaticoSeAtivo();
  }

  function excluirDadosDia(usuario, data) {
    if (!confirm(`Tem certeza que deseja excluir os dados de ${usuario} do dia ${data}?`)) {
      return;
    }

    // Obter ranking existente
    const ranking = JSON.parse(localStorage.getItem('ranking') || '{}');
    
    if (ranking[usuario] && ranking[usuario][data]) {
      delete ranking[usuario][data];
      
      // Se o usuário não tiver mais dados, remover o usuário do ranking
      if (Object.keys(ranking[usuario]).length === 0) {
        delete ranking[usuario];
      }
      
      // Salvar ranking
      localStorage.setItem('ranking', JSON.stringify(ranking));
      alert('Dados excluídos com sucesso!');
      atualizarTabelasRanking();
      backupAutomaticoSeAtivo();
    } else {
      alert('Dados não encontrados!');
    }
  }

  // Fechar modal ao clicar fora dele
  window.onclick = function(event) {
    const modal = document.getElementById('modalEdicao');
    if (event.target === modal) {
      fecharModalEdicao();
    }
  }

  // Inicializar datepicker para o campo de data do ranking
  document.addEventListener('DOMContentLoaded', function() {
    flatpickr("#folgaAdminData", {
      mode: "multiple",
      dateFormat: "Y-m-d",
      locale: "pt"
    });
    
    flatpickr("#dataRanking", {
      dateFormat: "Y-m-d",
      locale: "pt",
      defaultDate: new Date()
    });

    // Chamar a função de atualização inicial dos dados detalhados
    // Isso garante que os dados sejam carregados quando a aba de ranking for exibida pela primeira vez
    // (Pode ser necessário ajustar onde chamar isso dependendo da lógica de inicialização das abas)
    if (document.getElementById("rankingContent").classList.contains("active")) {
        atualizarDadosDetalhadosDiarios();
    }

    // Chamar a função de atualização inicial das metas se a aba de metas estiver ativa
    if (document.getElementById("metasContent").classList.contains("active")) {
        preencherFiltroMesMetas();
        atualizarTabelasMetas();
    }
  });

  // Função para atualizar as tabelas de metas
  function atualizarTabelasMetas() {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const ranking = JSON.parse(localStorage.getItem("ranking") || "{}");
    
    // Obter filtros
    const filtroTurno = document.getElementById("filtroTurnoMetas").value;
    const filtroMes = document.getElementById("filtroMesMetas").value;
    
    // Obter meta para o mês selecionado
    const metasVendasMensais = JSON.parse(localStorage.getItem("metasVendasMensais") || "{}");
    const mesReferencia = filtroMes === 'todos' ? new Date().getMonth() : parseInt(filtroMes);
    const metaGeral = metasVendasMensais[mesReferencia] || parseInt(localStorage.getItem("metaGeral")) || 1000;

    // Atualizar o input da meta na seção admin se estiver visível
    if (document.getElementById("metaGeralInput")) {
      document.getElementById("metaGeralInput").value = metaGeral;
      document.getElementById("metaGeralMesSelect").value = mesReferencia;
    }
    
    const metasManhaTable = document.getElementById("metasManhaTable").getElementsByTagName("tbody")[0];
    const metasTardeTable = document.getElementById("metasTardeTable").getElementsByTagName("tbody")[0];
    
    // Limpar tabelas
    metasManhaTable.innerHTML = "";
    metasTardeTable.innerHTML = "";
    
    // Obter mês e ano para filtro
    let mesParaFiltro, anoParaFiltro;
    if (filtroMes === 'todos') {
      // Se for "todos", usar mês atual como referência para o ano
      const hoje = new Date();
      mesParaFiltro = null; // null indica todos os meses
      anoParaFiltro = hoje.getFullYear();
    } else {
      const hoje = new Date();
      mesParaFiltro = parseInt(filtroMes) + 1; // filtroMes é 0-11, mas precisamos 1-12
      anoParaFiltro = hoje.getFullYear();
    }
    
    // Verificar se o usuário logado é funcionário
    if (usuarioLogado && usuarioLogado.tipo === 'funcionario') {
      // Para funcionários: mostrar apenas sua própria meta
      const vendasMensais = calcularVendasMensais(usuarioLogado.login);
      const faltaParaMeta = Math.max(0, metaGeral - vendasMensais);
      const progressoPorcentagem = Math.min((vendasMensais / metaGeral) * 100, 100);
      
      // Determinar em qual tabela mostrar (baseado no turno do funcionário)
      const tabelaDestino = usuarioLogado.turno === 'manha' ? metasManhaTable : metasTardeTable;
      const tabelaOutroTurno = usuarioLogado.turno === 'manha' ? metasTardeTable : metasManhaTable;
      
      // Verificar se o filtro de turno permite mostrar os dados do funcionário
      const mostrarDados = filtroTurno === 'todos' || 
                          (filtroTurno === 'manha' && usuarioLogado.turno === 'manha') ||
                          (filtroTurno === 'tarde' && usuarioLogado.turno === 'tarde');
      
      if (mostrarDados) {
        // Mostrar dados do funcionário na tabela do seu turno
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${usuarioLogado.login}</td>
          <td>
            Vendas: ${vendasMensais}<br>
            Falta: ${faltaParaMeta}
          </td>
          <td>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${progressoPorcentagem}%">
                ${progressoPorcentagem.toFixed(1)}%
              </div>
            </div>
          </td>
        `;
        tabelaDestino.appendChild(row);
        
        // Mostrar mensagem na tabela do outro turno
        const rowOutroTurno = document.createElement("tr");
        rowOutroTurno.innerHTML = '<td colspan="3">Você não tem acesso aos dados deste turno</td>';
        tabelaOutroTurno.appendChild(rowOutroTurno);
      } else {
        // Filtro não permite mostrar os dados do funcionário
        const rowManha = document.createElement("tr");
        rowManha.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
        metasManhaTable.appendChild(rowManha);
        
        const rowTarde = document.createElement("tr");
        rowTarde.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
        metasTardeTable.appendChild(rowTarde);
      }
      
      return; // Sair da função para funcionários
    }
    
    // Para administradores: mostrar todas as metas (código original)
    // Separar usuários por turno
    const usuariosManha = [];
    const usuariosTarde = [];
    
    usuarios.forEach(usuario => {
      if (usuario.turno === "manha") {
        usuariosManha.push({login: usuario.login, ...usuario});
      } else if (usuario.turno === "tarde") {
        usuariosTarde.push({login: usuario.login, ...usuario});
      }
    });
    
    // Função para criar linha da tabela
    function criarLinhaTabela(usuario) {
      const vendasMensais = calcularVendasMensais(usuario.login);
      const faltaParaMeta = Math.max(0, metaGeral - vendasMensais);
      
      const progressoPorcentagem = Math.min((vendasMensais / metaGeral) * 100, 100);
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${usuario.login}</td>
        <td>
          Vendas: ${vendasMensais}<br>
          Falta: ${faltaParaMeta}
        </td>
        <td>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${progressoPorcentagem}%">
              ${progressoPorcentagem.toFixed(1)}%
            </div>
          </div>
        </td>
      `;
      return row;
    }
    
    // Preencher tabela da manhã
    if (filtroTurno === "todos" || filtroTurno === "manha") {
      if (usuariosManha.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="3">Nenhum funcionário do turno da manhã</td>';
        metasManhaTable.appendChild(row);
      } else {
        usuariosManha.forEach(usuario => {
          metasManhaTable.appendChild(criarLinhaTabela(usuario));
        });
      }
    } else {
      const row = document.createElement("tr");
      row.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
      metasManhaTable.appendChild(row);
    }
    
    // Preencher tabela da tarde
    if (filtroTurno === "todos" || filtroTurno === "tarde") {
      if (usuariosTarde.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="3">Nenhum funcionário do turno da tarde</td>';
        metasTardeTable.appendChild(row);
      } else {
        usuariosTarde.forEach(usuario => {
          metasTardeTable.appendChild(criarLinhaTabela(usuario));
        });
      }
    } else {
      const row = document.createElement("tr");
      row.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
      metasTardeTable.appendChild(row);
    }
    
    // Função para calcular vendas mensais de um usuário considerando o filtro
    function calcularVendasMensais(login) {
      let totalVendas = 0;
      const dadosUsuario = ranking[login] || {};
      
      for (const data in dadosUsuario) {
        const dataObj = new Date(data);
        const mes = dataObj.getMonth() + 1;
        const ano = dataObj.getFullYear();
        
        // Aplicar filtro de mês
        if (mesParaFiltro === null) {
          // Todos os meses do ano atual
          if (ano === anoParaFiltro) {
            totalVendas += dadosUsuario[data].vendas || 0;
          }
        } else {
          // Mês específico do ano atual
          if (mes === mesParaFiltro && ano === anoParaFiltro) {
            totalVendas += dadosUsuario[data].vendas || 0;
          }
        }
      }
      
      return totalVendas;
    }
  }
  
  // Função para salvar a meta geral por mês
  function salvarMetaGeral() {
    const mesSelect = document.getElementById("metaGeralMesSelect");
    const metaInput = document.getElementById("metaGeralInput");
    const mes = mesSelect.value;
    const meta = parseInt(metaInput.value) || 0;
    
    // Obter metas existentes
    const metasVendasMensais = JSON.parse(localStorage.getItem("metasVendasMensais") || "{}");
    metasVendasMensais[mes] = meta;
    
    // Salvar no localStorage
    localStorage.setItem("metasVendasMensais", JSON.stringify(metasVendasMensais));
    
    // Também salvar como meta geral para compatibilidade se for o mês atual
    const mesAtual = new Date().getMonth();
    if (parseInt(mes) === mesAtual) {
      localStorage.setItem("metaGeral", meta);
    }
    
    atualizarTabelasMetas();
    backupAutomaticoSeAtivo();
    alert("Meta de vendas para o mês selecionado salva com sucesso!");
  }

  // Função para salvar meta geral de grid por mês
  function salvarMetaGeralGrid() {
    const mesSelect = document.getElementById("metaGeralGridMesSelect");
    const metaInput = document.getElementById("metaGeralGridInput");
    const mes = mesSelect.value;
    const meta = parseInt(metaInput.value) || 0;
    
    // Obter metas existentes
    const metasGridMensais = JSON.parse(localStorage.getItem("metasGridMensais") || "{}");
    metasGridMensais[mes] = meta;
    
    // Salvar no localStorage
    localStorage.setItem("metasGridMensais", JSON.stringify(metasGridMensais));
    
    // Também salvar como meta geral para compatibilidade se for o mês atual
    const mesAtual = new Date().getMonth();
    if (parseInt(mes) === mesAtual) {
      localStorage.setItem("metaGeralGrid", meta);
    }
    
    atualizarTabelasMetasGrid();
    backupAutomaticoSeAtivo();
    alert("Meta de grid para o mês selecionado salva com sucesso!");
  }

  // Função para atualizar as tabelas de metas de grid
  function atualizarTabelasMetasGrid() {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    const ranking = JSON.parse(localStorage.getItem("ranking") || "{}");
    
    // Obter filtros
    const filtroTurno = document.getElementById("filtroTurnoMetasGrid").value;
    const filtroMes = document.getElementById("filtroMesMetasGrid").value;
    
    // Obter meta para o mês selecionado
    const metasGridMensais = JSON.parse(localStorage.getItem("metasGridMensais") || "{}");
    const mesReferencia = filtroMes === 'todos' ? new Date().getMonth() : parseInt(filtroMes);
    const metaGeralGrid = metasGridMensais[mesReferencia] || parseInt(localStorage.getItem("metaGeralGrid")) || 500;

    // Atualizar o input da meta na seção admin se estiver visível
    if (document.getElementById("metaGeralGridInput")) {
      document.getElementById("metaGeralGridInput").value = metaGeralGrid;
      document.getElementById("metaGeralGridMesSelect").value = mesReferencia;
    }
    
    const metasGridManhaTable = document.getElementById("metasGridManhaTable").getElementsByTagName("tbody")[0];
    const metasGridTardeTable = document.getElementById("metasGridTardeTable").getElementsByTagName("tbody")[0];
    
    // Limpar tabelas
    metasGridManhaTable.innerHTML = "";
    metasGridTardeTable.innerHTML = "";
    
    // Obter mês e ano para filtro
    let mesParaFiltro, anoParaFiltro;
    if (filtroMes === 'todos') {
      // Se for "todos", usar mês atual como referência para o ano
      const hoje = new Date();
      mesParaFiltro = null; // null indica todos os meses
      anoParaFiltro = hoje.getFullYear();
    } else {
      const hoje = new Date();
      mesParaFiltro = parseInt(filtroMes) + 1; // filtroMes é 0-11, mas precisamos 1-12
      anoParaFiltro = hoje.getFullYear();
    }
    
    // Verificar se o usuário logado é funcionário
    if (usuarioLogado && usuarioLogado.tipo === 'funcionario') {
      // Para funcionários: mostrar apenas sua própria meta de grid
      const gridMensais = calcularGridMensais(usuarioLogado.login);
      const faltaParaMetaGrid = Math.max(0, metaGeralGrid - gridMensais);
      const progressoPorcentagem = Math.min((gridMensais / metaGeralGrid) * 100, 100);
      
      // Determinar em qual tabela mostrar (baseado no turno do funcionário)
      const tabelaDestino = usuarioLogado.turno === 'manha' ? metasGridManhaTable : metasGridTardeTable;
      const tabelaOutroTurno = usuarioLogado.turno === 'manha' ? metasGridTardeTable : metasGridManhaTable;
      
      // Verificar se o filtro de turno permite mostrar os dados do funcionário
      const mostrarDados = filtroTurno === 'todos' || 
                          (filtroTurno === 'manha' && usuarioLogado.turno === 'manha') ||
                          (filtroTurno === 'tarde' && usuarioLogado.turno === 'tarde');
      
      if (mostrarDados) {
        // Mostrar dados do funcionário na tabela do seu turno
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${usuarioLogado.login}</td>
          <td>
            Grid: ${gridMensais}<br>
            Falta: ${faltaParaMetaGrid}
          </td>
          <td>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${progressoPorcentagem}%">
                ${progressoPorcentagem.toFixed(1)}%
              </div>
            </div>
          </td>
        `;
        tabelaDestino.appendChild(row);
        
        // Mostrar mensagem na tabela do outro turno
        const rowOutroTurno = document.createElement("tr");
        rowOutroTurno.innerHTML = '<td colspan="3">Você não tem acesso aos dados deste turno</td>';
        tabelaOutroTurno.appendChild(rowOutroTurno);
      } else {
        // Filtro não permite mostrar os dados do funcionário
        const rowManha = document.createElement("tr");
        rowManha.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
        metasGridManhaTable.appendChild(rowManha);
        
        const rowTarde = document.createElement("tr");
        rowTarde.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
        metasGridTardeTable.appendChild(rowTarde);
      }
      
      return; // Sair da função para funcionários
    }
    
    // Para administradores: mostrar todas as metas de grid
    // Separar usuários por turno
    const usuariosManha = [];
    const usuariosTarde = [];
    
    usuarios.forEach(usuario => {
      if (usuario.turno === "manha") {
        usuariosManha.push({login: usuario.login, ...usuario});
      } else if (usuario.turno === "tarde") {
        usuariosTarde.push({login: usuario.login, ...usuario});
      }
    });
    
    // Função para criar linha da tabela
    function criarLinhaTabelaGrid(usuario) {
      const gridMensais = calcularGridMensais(usuario.login);
      const faltaParaMetaGrid = Math.max(0, metaGeralGrid - gridMensais);
      const progressoPorcentagem = Math.min((gridMensais / metaGeralGrid) * 100, 100);
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${usuario.login}</td>
        <td>
          Grid: ${gridMensais}<br>
          Falta: ${faltaParaMetaGrid}
        </td>
        <td>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${progressoPorcentagem}%">
              ${progressoPorcentagem.toFixed(1)}%
            </div>
          </div>
        </td>
      `;
      return row;
    }
    
    // Função auxiliar para calcular grid mensal
    function calcularGridMensais(login) {
      let totalGrid = 0;
      const dadosUsuario = ranking[login] || {};
      
      for (const data in dadosUsuario) {
        // Usar T00:00:00 para evitar problemas de fuso horário
        const dataObj = new Date(data + 'T00:00:00');
        const mes = dataObj.getMonth() + 1;
        const ano = dataObj.getFullYear();
        
        // Aplicar filtro de mês
        if (mesParaFiltro === null) {
          // Todos os meses do ano atual
          if (ano === anoParaFiltro) {
            totalGrid += dadosUsuario[data].grid || 0;
          }
        } else {
          // Mês específico do ano atual
          if (mes === mesParaFiltro && ano === anoParaFiltro) {
            totalGrid += dadosUsuario[data].grid || 0;
          }
        }
      }
      
      return totalGrid;
    }
    
    // Mostrar usuários do turno da manhã
    if (filtroTurno === 'todos' || filtroTurno === 'manha') {
      if (usuariosManha.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="3">Nenhum funcionário no turno da manhã</td>';
        metasGridManhaTable.appendChild(row);
      } else {
        usuariosManha.forEach(usuario => {
          metasGridManhaTable.appendChild(criarLinhaTabelaGrid(usuario));
        });
      }
    } else {
      const row = document.createElement("tr");
      row.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
      metasGridManhaTable.appendChild(row);
    }
    
    // Mostrar usuários do turno da tarde
    if (filtroTurno === 'todos' || filtroTurno === 'tarde') {
      if (usuariosTarde.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="3">Nenhum funcionário no turno da tarde</td>';
        metasGridTardeTable.appendChild(row);
      } else {
        usuariosTarde.forEach(usuario => {
          metasGridTardeTable.appendChild(criarLinhaTabelaGrid(usuario));
        });
      }
    } else {
      const row = document.createElement("tr");
      row.innerHTML = '<td colspan="3">Filtro aplicado para outro turno</td>';
      metasGridTardeTable.appendChild(row);
    }
  }

  // Remover a função atualizarMeta, pois a meta agora é geral
  // function atualizarMeta(login, novaMeta) {
  //   const metas = JSON.parse(localStorage.getItem('metas') || '{}');
  //   metas[login] = parseInt(novaMeta) || 0;
  //   localStorage.setItem('metas', JSON.stringify(metas));
  //   atualizarTabelasMetas();
  //   backupAutomaticoSeAtivo();
  // }

  // ================= METAS DE GRID =================
  </script>
</body>
</html>

